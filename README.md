# Аналитический сервис для агрегации пользовательской активности

Проект представляет собой backend-приложение, которое формирует аналитические датасеты на основе данных о пользовательской активности. Сервис агрегирует данные из нескольких баз данных и предоставляет их в удобном формате JSON по REST API.

---

## Используемый стек

- **Python 3.9**
    
- **FastAPI** + **Uvicorn** (веб-сервер)
    
- **PostgreSQL** в качестве СУБД
    
- Подключение к БД реализовано через **SQLAlchemy ORM**
    
- Тестирование: **pytest**, **unittest.mock**, **Testcontainers**
    

---

## Возможности проекта

Формирование двух типов датасетов по логину пользователя:

- **comments** — информация о комментариях пользователя к постам.
    
- **general** — общая статистика действий пользователя (входы, выходы, действия в блогах).
    

REST API на базе FastAPI.

Гибкая и расширяемая архитектура, позволяющая легко перейти на другую СУБД (например, ClickHouse).

---

## Особенности реализации

### Общий справочник пользователей

В проекте создан единый справочник пользователей (`db1.users`), который используется для идентификации авторов и участников активности в обеих базах данных (`db1` и `db2`).

**Причина:**

Изначально в техническом задании существовала нестыковка — таблица логов активности `db2.logs` хранила идентификаторы пользователей без единого справочника, что привело бы к несогласованности данных и проблемам целостности. Для решения этой проблемы и обеспечения согласованности идентификаторов был введен единый справочник пользователей. Это упрощает интеграцию данных между базами и позволяет избежать потенциальных ошибок при агрегировании информации.

### Слоистая архитектура

- **Четкое разделение слоев:** бизнес-логика отделена от инфраструктуры и контроллеров.
    
- **Простота расширения:** можно легко перейти с PostgreSQL на ClickHouse без изменения бизнес-логики.
    
- **Прозрачное тестирование:** юнит-тесты легко поддерживать и расширять.
    
- **Документированность:** наличие документации упрощает сопровождение и развитие проекта.
    

---

## Тестирование

В проекте реализована трехуровневая система тестирования:

- **Unit-тесты** (`pytest`, `mock`) — проверяют бизнес-логику с моками вместо реальных запросов к БД.
    
- **Интеграционные тесты** — проверяют корректность взаимодействия с реальными тестовыми базами данных.
    
- **End-to-End (E2E) тесты** — проверяют всю цепочку вызовов API через TestClient (FastAPI) и Testcontainers PostgreSQL.
    

Запуск всех тестов:

```bash
poetry run pytest -q
```

---

## Запуск проекта

**Установите зависимости:**

```bash
poetry install
```

**Создайте `.env` файл на основе `.env.example`:**

```bash
cp .env.example .env
```

**Примените миграции базы данных:**

```bash
alembic upgrade heads
```

**Запустите FastAPI приложение:**

```bash
uvicorn app.main:app --reload
```

Сервис будет доступен по адресу: [http://127.0.0.1:8000](http://127.0.0.1:8000/)

---

## Примеры вызовов API

### Получить датасет комментариев пользователя:

**Запрос:**

```http
GET http://localhost:8000/api/comments/?login=vladimir
```

**Ответ:**

```json
{
  "status": "ok",
  "data": [
    {
      "user_login": "vladimir",
      "post_header": "ЖК Эдельвейс",
      "post_author_login": "vladimir",
      "total_comments": 1
    }
  ]
}
```

---

### Получить общую статистику действий:

**Запрос:**

```http
GET http://localhost:8000/api/general/?login=vladimir
```

**Ответ:**

```json
{
  "status": "ok",
  "data": [
    {
      "date": "2025-06-29",
      "logins": 1,
      "logouts": 1,
      "blog_actions": 0
    }
  ]
}
```

---
